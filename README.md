個人用のブックマークリストを作るChrome 拡張

### UI

- 拡張アイコンをクリックすると「Bookmark success」というポップアップを表示する（重複時は「既にブックマークされています」と表示）
- ブックマークリストはブックマークした記事のタイトルをリンクで表示
- ブックマークリストを表示する前にパスワード認証が必要（初回起動時にパスワードを設定、または「パスワードを利用しない」を選択可能）
- 最上部に「検索フォーム」を用意して検索できるように
- 最大で100件表示。以降はページ送り
- ダウンロードボタンを用意してクリックするとCSVファイルでダウンロードできるようにする
- クリアボタンで全ブックマークを削除できる

## インストール方法

1. アイコンファイルを生成する（以下のいずれかの方法）

   **方法1: HTMLツールを使用（推奨）**
   - `generate-icons.html`をブラウザで開く
   - 各サイズのアイコンの下にある「ダウンロード」ボタンをクリック
   - ダウンロードしたファイルを`icons`フォルダに保存

   **方法2: Pythonスクリプトを使用**
   ```bash
   pip install Pillow
   python generate-icons.py
   ```

2. Chrome拡張機能を読み込む
   - Chromeで`chrome://extensions/`を開く
   - 「デベロッパーモード」を有効にする
   - 「パッケージ化されていない拡張機能を読み込む」をクリック
   - このプロジェクトのフォルダを選択

## 使用方法

1. ブックマークを追加: 拡張機能のアイコンをクリックすると、現在のページがブックマークに追加されます
2. ブックマークリストを表示: 以下のいずれかの方法でブックマークリストを開けます
   - 拡張アイコンをクリックした後、ポップアップ内でCtrlキー（MacではCommandキー）を押すと、ブックマークを追加せずに直接リストが開きます
   - ショートカットキー `Ctrl+Shift+B`（Macでは`Command+Shift+B`）を押す
   - 拡張アイコンを右クリックして「ブックマークリストを開く」を選択
3. パスワード認証: ブックマークリストを表示する前にパスワード入力画面が表示されます。初回起動時はパスワードを設定するか、「パスワードを利用しない」を選択できます。パスワードを設定した場合は、パスワードを入力して「ロック解除」ボタンをクリック（またはEnterキーを押す）してください。一度認証すると、ブラウザタブを閉じるまで再認証は不要です
4. パスワードの設定・変更: 拡張アイコンを右クリックして「パスワードを設定（変更）する」を選択すると、パスワードの設定や変更ができます。既にパスワードが設定されている場合は、現在のパスワードを入力してから新しいパスワードを設定します
5. パスワードを忘れた場合: パスワード入力画面の「パスワードを忘れた場合」リンクをクリックすると、すべてのデータ（ブックマーク、パスワード設定）を削除してリセットできます。この操作は取り消せません。CSVバックアップがある場合は、リセット後にインポートして復元できます
6. 手動同期: 拡張アイコンを右クリックして「同期する」を選択すると、サーバーから最新のブックマークデータを取得して同期できます。パスワードでログインできない場合でも、この機能で同期できます。同期が完了すると通知が表示されます
7. 検索: リストページ上部の検索フォームでタイトルやURLを検索できます
8. 保護機能: 各ブックマークの左側にある星マーク（☆）をクリックすると保護状態（★）になります。保護されたブックマークは常にリストの上部に表示され、容量が100KBを超えた場合の自動削除からも除外されます
9. 個別削除: 各ブックマーク項目の右側にある「×」ボタンをクリックすると、そのブックマークを個別に削除できます（確認ダイアログが表示されます）
10. CSVダウンロード: 「CSVダウンロード」ボタンでブックマークをCSV形式でダウンロードできます。パスワードが設定されている場合、CSVファイルは自動的に暗号化されて`.encrypted.csv`ファイルとしてエクスポートされます（パスワード入力が必要です）
11. CSVインポート: リストページ最下部の「CSVインポート」ボタンで、エクスポートしたCSVファイルをインポートしてブックマークを復元できます。暗号化されたCSVファイル（`.encrypted.csv`）をインポートする場合は、パスワードを入力して復号化します。既存のブックマークがある場合は追加されます（重複するURLはスキップされます）
12. クリア: 「クリア」ボタンで全ブックマークを削除できます（確認ダイアログが表示されます）
13. 自動削除: 容量が100KBを超えた場合、保護されていない古いブックマークから自動的に削除されます（保護されたブックマークは削除されません）

## 重要な注意事項

### データの保存について

- ブックマークデータは `chrome.storage.sync` に保存され、**同じGoogleアカウントでログインしているすべてのChromeブラウザで自動的に同期されます**
- 同期ストレージの容量制限は約100KBです。ブックマークリストの上部に現在の使用容量が表示されます
- 容量が80%を超えると警告色（赤）で表示されます
- 容量制限に達した場合、新しいブックマークを追加できなくなる可能性があります
- **拡張機能を削除（アンインストール）すると、すべてのブックマークデータが削除されます**
- データを保護するため、定期的にCSVダウンロード機能でバックアップを取得することを推奨します
- 拡張機能を再インストールする場合は、事前にCSVでバックアップを取得し、CSVインポート機能で復元してください

### 同期機能について

- ブックマークデータは自動的にGoogleアカウント間で同期されます
- **保護状態も含めて同期されます**。あるデバイスでブックマークを保護すると、他のデバイスでも同じ保護状態が反映されます
- 同期には数秒〜数分かかる場合があります
- オフライン時はローカルに保存され、オンライン復帰時に自動的に同期されます
- 複数のデバイスで同じGoogleアカウントを使用している場合、すべてのデバイスで同じブックマークデータ（保護状態を含む）にアクセスできます
- **PCや住所が異なる自宅と事務所でも、同じGoogleアカウントでログインしていればデータは自動的に共有されます**

#### 手動同期について

- 拡張アイコンを右クリックして「同期する」を選択すると、サーバーから最新のブックマークデータを取得して同期できます
- **パスワードでログインできない場合でも、この機能で同期できます**
- 同期が完了すると通知が表示されます（3秒後に自動で閉じます）
- 事務所で拡張をインストールした直後など、自動同期がまだ完了していない場合に便利です
- 手動同期を実行すると、サーバーから最新データを取得し、ローカルデータを更新します

#### 同期のタイミング

- **自動同期**: Chromeが自動的に同期を実行します（通常は数秒〜数分）
- **手動同期**: 拡張アイコンの右クリックメニューから「同期する」を選択
- **初回インストール時**: 事務所で拡張をインストールした直後は、自宅で設定したパスワードやブックマークがまだ同期されていない可能性があります。この場合は手動同期を実行してください

### 重複データの処理について

#### 重複時の動作

1. **同じ記事を再度ブックマークした場合**
   - 「既にブックマークされています」というメッセージが表示されます
   - 既存のブックマークの日時が現在の日時に更新されます
   - 既存のブックマークがリストの先頭に移動します
   - 保護状態は維持されます

2. **CSVインポート時の重複処理**
   - 既存のブックマークとURLが重複する場合は、インポート時にスキップされます
   - 重複した件数がメッセージに表示されます

3. **同期時の自動重複チェック**
   - 他のデバイスから同期された際に、同じURLのデータが複数存在する場合、自動的に重複を削除します
   - 重複削除の優先順位：
     1. 日時が新しいものを優先
     2. 日時が同じ場合は、保護されているものを優先
     3. どちらも同じ場合は、既存のものを残す

#### データの同期と重複

- **CSVインポート後の同期**
  - CSVインポート後に他のデバイスから古いデータが同期された場合、重複が発生する可能性があります
  - この場合、自動的に重複チェックが実行され、最新のデータを残して古いデータを削除します
  - ブックマーク読み込み時にも自動的に重複をチェック・削除します

- **複数デバイス間での同期**
  - 自宅と事務所など、異なる場所のPCでも同じGoogleアカウントでログインしていれば、データは自動的に同期されます
  - 一方のデバイスで拡張機能を削除しても、もう一方のデバイスのデータには影響しません
  - ただし、削除したデバイスで再インストールしても、データは自動復元されません（CSVインポートが必要）

#### 重複データの自動整理

- ブックマーク読み込み時に自動的に重複をチェック
- ストレージ変更時（同期など）に自動的に重複をチェック
- 重複が見つかった場合、自動的に削除してストレージに保存

### パスワード機能について

#### パスワードの設定

- 初回起動時にパスワードを設定するか、「パスワードを利用しない」を選択できます
- パスワードはSHA-256でハッシュ化されて保存されます（平文では保存されません）
- パスワードは4文字以上で設定できます
- パスワードを設定しない場合でも、ブックマークリストにアクセスできます

#### パスワードの変更

- 拡張アイコンを右クリックして「パスワードを設定（変更）する」を選択すると、パスワードの設定や変更ができます
- 既にパスワードが設定されている場合は、現在のパスワードを入力してから新しいパスワードを設定する必要があります
- パスワード変更時は、認証が必要な場合があります

#### パスワードを忘れた場合のデータリセット

- パスワード入力画面の「パスワードを忘れた場合」リンクをクリックすると、データリセット機能が利用できます
- データリセットを実行すると、**すべてのデータ（ブックマーク、パスワード設定）が削除されます**
- この操作は取り消せません
- リセット前に2回の確認ダイアログが表示され、データが失われる旨が明記されます
- CSVバックアップがある場合は、リセット後にCSVインポート機能で復元できます
- リセット後は、初回起動時のパスワード設定画面が表示されます

#### パスワードのセキュリティ

- パスワードはハッシュ化されて保存されるため、ストレージから直接パスワードを読み取ることはできません
- パスワード設定は`chrome.storage.sync`に保存されるため、同じGoogleアカウントでログインしているすべてのデバイスで同期されます
- パスワードを忘れた場合の救済措置として、データリセット機能が用意されています

### CSVファイルの暗号化について

#### 暗号化の仕組み

- **パスワード設定時**: パスワードが設定されている場合、CSVファイルをエクスポートする際に自動的に暗号化されます
- **暗号化方式**: AES-GCM（256ビット）を使用してCSVデータを暗号化します
- **キー導出**: PBKDF2を使用してパスワードから暗号化キーを導出します（100,000回の反復処理）
- **セキュリティ強化**: ランダムなソルト（salt）と初期化ベクトル（IV）を生成して、同じパスワードでも異なる暗号文が生成されます

#### エクスポート時の動作

- **パスワード設定時**:
  1. 「CSVダウンロード」ボタンをクリック
  2. パスワード入力ダイアログが表示されます（4文字以上）
  3. パスワードを入力すると、CSVデータが暗号化されます
  4. `.encrypted.csv`ファイルとしてダウンロードされます

- **パスワード未設定時**:
  - 通常のCSVファイル（`.csv`）としてダウンロードされます
  - 暗号化は行われません

#### インポート時の動作

- **暗号化されたCSVファイル（`.encrypted.csv`）の場合**:
  1. 「CSVインポート」ボタンをクリック
  2. `.encrypted.csv`ファイルを選択
  3. パスワード入力ダイアログが表示されます
  4. 正しいパスワードを入力すると、データが復号化されてインポートされます
  5. パスワードが間違っている場合、エラーメッセージが表示されます

- **通常のCSVファイル（`.csv`）の場合**:
  - 従来通り、パスワード入力なしでインポートできます

#### セキュリティ上の注意事項

- **パスワードの管理**: 暗号化されたCSVファイルのパスワードは、エクスポート時に設定したパスワードです。このパスワードを忘れると、ファイルを復号化できません
- **パスワードの強度**: セキュリティを高めるため、強力なパスワード（長く、複雑な文字列）の使用を推奨します
- **ファイルの保管**: 暗号化されたCSVファイルは、パスワードを知らない第三者には内容を読み取ることができませんが、ファイル自体の保管にも注意してください
- **パスワードの共有**: 暗号化されたCSVファイルを他の人と共有する場合は、パスワードを安全な方法で共有してください（パスワードとファイルを同じ方法で送信しないなど）

#### 暗号化の技術仕様

- **暗号化アルゴリズム**: AES-GCM（Advanced Encryption Standard - Galois/Counter Mode）
- **キー長**: 256ビット
- **キー導出関数**: PBKDF2（Password-Based Key Derivation Function 2）
- **ハッシュ関数**: SHA-256
- **反復回数**: 100,000回
- **ソルト長**: 16バイト（ランダム生成）
- **IV長**: 12バイト（ランダム生成）
- **エンコーディング**: Base64

## ファイル構成

- `manifest.json` - 拡張機能の設定ファイル
- `popup.html/js/css` - アイコンクリック時のポップアップ
- `list.html/js/css` - ブックマークリスト表示ページ
- `background.js` - バックグラウンドスクリプト（Service Worker）
- `icons/` - 拡張機能のアイコンファイル（16x16, 48x48, 128x128）
- `generate-icons.html` - アイコン生成ツール（HTML版）
- `generate-icons.py` - アイコン生成ツール（Python版）